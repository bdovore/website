<?php 

$ficheAlbum = $view->getHelper('ficheAlbum');



?>
	<script language="JavaScript">
		
                $.datepicker.setDefaults( $.datepicker.regional[ "fr" ] );
    
		$(function() {
                    $( "#date_achat" ).datepicker({dateFormat: "dd/mm/yy"});
                });
		function changeEdition () {
			window.location="album?id_tome=<?php echo $view->tome->ID_TOME;?>&id_edition="+ document.getElementById('sel_edition').value;
		}
		
		function liencorrection () {
			parent.location.href="prop_correct?alb_id=<?php echo $view->tome->ID_TOME;?>&id_edition="+ document.getElementById('sel_edition').value;
			window.close();
		}
		
		function openSerie(){
			if (window.name == "Album") {
				window.opener.location="<?php echo BDO_URL;?>SerieBD?id_serie=<?php echo $view->tome->ID_SERIE;?>";}
			else {
			parent.location="<?php echo BDO_URL;?>SerieBD?id_serie=<?php echo $view->tome->ID_SERIE;?>";
			}
		}
		
		function setDteAchat(){
                    if (!$("cb_achat").is(':checked')) {
                            d = new Date();
                            mm = d.getMonth() + 1;
                            yyyy = d.getFullYear();
                            dd = d.getDate();
                            dte = "";
                            if (dd < 10) {
                                    dte = "0" + dd;
                            }
                            else {
                                    dte += dd;
                            }
                            if (mm < 10) {
                                    dte = dte + "/0" + mm;
                            }
                            else {
                                    dte = dte + "/" + mm;
                            }
                            dte = dte + "/" + yyyy;
                            $("#date_achat").val(dte);
                }
}
        //-->	
            getComment(page=1, id_tome=<?php echo $view->tome->ID_TOME;?> );
            
            
            
            function viewComment() {
                
                <?php  if ($view->connected) { ?>
                                       
                $("#writecomment").show(100);
                offset = $("#writecomment").offset().top;
                $('html, body').animate({scrollTop: offset}, 'slow');
                <?php }
                 else { 
                                            echo "alert('Vous devez vous authentifier pour écrire un avis de lecture !');";
                                        }
                                        ?>
            }
            
            function myComment(){
                writeComment($("#id_tome").val(),$("input[name='note']").val()*2, $("#t_comment").val() );
                $("#listcomment").empty();             
                
                
                getComment(page=1, id_tome=<?php echo $view->tome->ID_TOME;?>);
            }
           
           function saveCollection() {
               if (!isValidEmailAddress($("#email_pret").val()) && $("#email_pret").val() != "") {
                 alert("L'adresse email de l'emprunteur est erroné !");
             } 
             else {
                $("#save_collection").html("<img src='./script/ajax-loader.gif'>"); 

                var url = "./Macollection/majcollection?id_edition="+$("#user_edition").val();
                url += "&id_tome="+<?php echo $view->tome->ID_TOME; ?>;
                url += "&flg_achat="+ ($("#cb_achat").is(':checked') ? "O" : "N");
                url+= "&flg_pret="+($("#cb_pret").is(':checked') ? "O" : "N");
                url+= "&flg_dedicace="+($("#cb_dedicace").is(':checked') ? "O" : "N");
                url+= "&flg_tete="+($("#cb_tete").is(':checked') ? "O" : "N");
                url+= "&flg_cadeau="+ ($("#cb_cadeau").is(':checked') ? "O" : "N");
                url+= "&flg_lu="+ ($("#cb_lu").is(':checked') ? "O" : "N");
                url+= "&date_achat="+$("#date_achat").val();
                url+= "&email_pret="+$("#email_pret").val();
                url+= "&nom_pret="+$("#nom_pret").val();
                url+= "&cote="+$("#prix").val();
                url+= "&comment="+encodeURIComponent($("#remarque").val());
                //alert (url);


                $.getJSON(url, function (data) {

                           if (data.length == 0) {$("#save_collection").html('<input type="button" value="Enregistrer les modifications" onclick="saveCollection();"/> <br>Données mises à jour !')};   

                        }

                   );
                }
            }
	</script>

<div class="conteneuralb">
      
			<div class="alb-img">
				<img src="<?php echo BDO_URL_COUV;?><?php echo ($view->tome->IMG_COUV) ? $view->tome->IMG_COUV : "default.png";?>" width="160" border="1" name="imgEdition" id="imgEdition" alt="couverture"> 
                                <div class="petite_police">&copy;<?php echo $view->tome->NOM_EDITEUR;?>/<?php echo $view->tome->scpseudo; ?></div>
                                <div id="sponsor"><?php echo $ficheAlbum->getSponsor($view->tome); ?></div>
                 
                <?php echo $view->COMMENT_EDITION;?>
                <a href="<?php echo BDO_URL;?>simil?ID_TOME=<?php echo $view->tome->ID_TOME ?>" target="_parent" title="Albums similaires..." align="right">vous devriez aimer aussi...</a>
			</div>
		
	    <div class="contentalb" id="alb-description">
			
			<h3 align="center"><?php echo $ficheAlbum->getTitreTome($view->tome,$url=false);?>  <br>  
                            <?php echo $ficheAlbum->urlSerie($view->tome,"_parent");?>
                           
                        </h3>
                <p align="center">
                                <font size="-1"><?php if ($view->tome->NB_NOTE_TOME > 0) { ?> <span id="noteTome<?php echo $view->tome->ID_TOME; ?>" style="vertical-align: -3px;"> </span> <script>$('#noteTome<?php echo $view->tome->ID_TOME; ?>').raty({score: <?php echo $view->tome->MOYENNE_NOTE_TOME/2.0; ?>, readOnly: true});</script> pour <?php echo $view->tome->NB_NOTE_TOME ?> notes. <?php ;} ?></font>
                </p> 
			<?php echo $view->tome->NOM_GENRE;?>  -   <?php echo $view->tome->scpseudo. ($view->tome->scapseudo == "Aucun" ? "" : " - ".$view->tome->scapseudo); if ($view->tome->scpseudo <> $view->tome->depseudo || $view->tome->deapseudo <> "Aucun" ) echo "/".$view->tome->depseudo.($view->tome->deapseudo == "Aucun" ? "" : " - ". $view->tome->deapseudo); ?>  
                        <?php if ($view->tome->copseudo <> $view->tome->depseudo and $view->tome->copseudo <> "Aucun" and $view->tome->copseudo <> "<indéterminé>") echo "<br>Couleur : ".htmlspecialchars ($view->tome->copseudo); ?>
					<br> <b>Edition </b> <font size="-1">
			                <?php if (count($view->dbs_edition->a_dataQuery) == 1) {
                                                $dateparution = new DateTime($view->dateparution);
                                                echo $view->tome->NOM_EDITEUR." - ".$dateparution->format("d/m/Y") ;
                                                $edition_selected = $view->tome->ID_EDITION;
                                        }
                                        else {
                                            echo '<select name="select" onchange="changeEdition()" id="sel_edition">';
                                            $edition_selected = $view->tome->USER_EDITON ? $view->tome->USER_EDITON : $view->tome->ID_EDITION;
                                            foreach ($view->dbs_edition->a_dataQuery as $edition){
                                                // on ajoute les options
                                                echo '<option value="'.$edition->ID_EDITION .'"'.($edition->ID_EDITION == $edition_selected ? 'selected=""' : '') .'>'.$edition->NOM_EDITION .'</option>';
                                            }
                                            echo "</select>";
                                        }
                                        ?>
						<?php echo $view->tome->NOM_COLLECTION == "<N/A>" ? "" : "<br> Collection ".$view->tome->NOM_COLLECTION;?>
					<br> 
						<span class="petite_police">
					ISBN-13 (EAN) : <?php echo $view->tome->EAN_EDITION;?> || ISBN-10 : <?php echo $view->tome->ISBN_EDITION;?> || ID-BDovore : <?php echo $view->tome->ID_TOME;?> </span>
					
			<div class="action" id="action-menu">
				<div align="center">
					<div id="actionCollection"></div>
                                    <?php if ($view->tome->DATE_AJOUT) { ?> 
                                     <div class="ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;">
                                            <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span><i>Votre édition est différente ? Vous pouvez 
                                                    <a href="<?php echo BDO_URL; ?>Proposition?type=EDITION&id_tome=<?php echo $view->tome->ID_TOME; ?>">
								<b>proposer une édition</b>
										</a></i></p></div>
                                    <?php } ?>
				</div>
                          
                        </div>
		
	</div>		
    
    
        <div class="synopsis">
            <?php if ($view->tome->HISTOIRE_TOME <> "") { ?>
                <strong>Synopsis :</strong>

                                 <font size="-1">
                                        <?php echo nl2br($view->tome->HISTOIRE_TOME);?>
                                        </font>
            <?php } ?>
                                        <br><div class="ui-state-highlight ui-corner-all" style="margin-top: 20px; padding: 0 .7em;">
                                            <p><span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span><i>Une erreur sur cette fiche ? Vous pouvez 
                                                    <a href="<?php echo BDO_URL; ?>Proposition?id_edition=<?php echo $edition_selected; ?>" >
								<b>proposer une correction</b>
										</a></i></p></div>



        </div>
    
	  <div id="info_collection">
              <center><strong>Données privées</strong><br><span class="petite_police">(pour votre utilisation personnelle)</span></center>
				<hr style="align: center; width: 50%;">
                                <input type="hidden" id="user_edition" value="<?php echo $view->tome->ID_EDITION; ?>" />
				<table> 
                                     <tr>
                                        <td>
                                         Futur achat : <input name="cb_achat" id="cb_achat" value="O" type="checkbox" onclick="setDteAchat();">
					Date d'achat : <span class="petite_police">(dd/mm/aaaa)</span>	<input name="date_achat" id="date_achat" value="" size="10" maxlength="10" type="text">	
	
										
					Prix/cote :<input name="prix" id="prix" value="" size="4" maxlength="8" type="text">
                                    </td>
                                </tr>	
                                    <tr>
                                        <td>
				
					E.O :	<input name="cb_tete" id="cb_tete" value="O" type="checkbox" >
                                        Dédicace : <input name="cb_dedicace" id="cb_dedicace" value="O" type="checkbox" >
                                         Cadeau :<input name="cb_cadeau" id="cb_cadeau" value="checkbox" type="checkbox" >
                                         Lu :<input name="cb_lu" id="cb_lu" value="checkbox" type="checkbox" >
					</td>
                                    </tr>
                                   	    
                                <tr>
                                    <td>
                                       
                                                Prêt :				
                                       
                                        <input name="cb_pret" id="cb_pret" value="checkbox" type="checkbox">		            
                                       						
                                                Dernier emprunteur :
                                       			        
                                        <input name="nom_pret" id="nom_pret" value="" size="15" maxlength="100" type="text" >			            
                                        
                                               								
                                                        Email :
                                               
                                         		           
                                        <input name="email_pret" id="email_pret" value="" size="15" maxlength="100" type="text">
                                    </td>
                                </tr>		    
                                    <tr>
                                    <td>
										
					Remarque personnelle (état, mémo, ...) :
                                        <textarea name="remarque" id="remarque" class="champ_commentaire"></textarea>
                                    </td>
                                    </tr>		
                                </table>
                                <div id="save_collection"><input type="button" value="Enregistrer les modifications" onclick="saveCollection();"/></div>
                                
                            </div>
    
      
        <div class="comment" id="comment">
                <font color="#990000" face="Arial, Helvetica, sans-serif" size="-1">
                        <strong>Commentaires des membres :</strong> <a onclick="viewComment();">
						
							(vous pouvez également donner un avis de lecture)
						
					</a>
                </font>
                <br>
                
                <div id="listcomment">
                                
                </div>
               
                <div id="writecomment">
                 
                    <table width="100%" border="0" align="center">			
				<tr> 						    
					<td width="70%">					
													
							<strong>Noter et donner votre avis de lecture pour <font color="#990000"><?php echo $view->tome->TITRE_TOME;?> </font></strong>						
										
					</td>				    		
				</tr>				
								
				    <tr> 									    
						<td>						
							Note: 
                                                        <div id="commentRaty"></div>
                                                        <script>$("#commentRaty").raty({ scoreName: 'note', half : true})</script>							
												
						</td>					    		   
					</tr>				    
					<tr>					  			    
						<td>Avis de lecture * : 
                                                 <textarea id="t_comment" class="champ_commentaire"></textarea></td>					    		    
					</tr>				    
							    
							    
					<tr>			    
						<td>						
							 			
								<input name="id_tome" type="hidden" id="id_tome" value="<?php echo $view->tome->ID_TOME ?>" />						        
								<input type="submit" name="Submit" value="Enregistrer note/avis" onclick="myComment();"/>					        
							<em>								
                                                            <br><font size="-1">									
										* : Avis de lecture qui apparaîtra pour tous les visiteurs sur le site
										<br />									
									</font>								
								</em>				
						</td>					    			   
					</tr>				
			</table>	
                   		

                </div>
        </div>
</div>
<script language="javascript">
   $("#writecomment").hide();
   $("#info_collection").hide();
   <?php if (User::minAccesslevel(2)) { ?>
      // récupération de l'éventuelle commentaire du membre
       var url = "./AlbumComment?page=1&id_tome=<?php echo $view->tome->ID_TOME; ?>&user_id=<?php echo $_SESSION['userConnect']->user_id;?>";
       $.getJSON(url,function (data) {
        if (data.length > 0) {
            $("#commentRaty").raty({ scoreName: 'note', half : true, score : data[0].NOTE / 2});
            $("#t_comment").val(data[0].COMMENT);
            $("#writecomment").show();
        }
        });
        
     function getInfoCollection () {
          $("#actionCollection").html("<img src='"+$.bdovore.URL+ "script/ajax-loader.gif'>");
     var url = $.bdovore.URL+"getjson?data=Useralbum&id_edition=<?php echo $view->tome->ID_EDITION?>";
      $.getJSON(url, function (data) {
          if (data.length == 0) {               
               // l'album n'est pas dans la collection : on ajoute les boutons
                $("#info_collection").hide();
                // Affichage des boutons
                 var madiv = '<div id="addAlbum<?php echo $view->tome->ID_EDITION; ?>" style="font-size:0.9em;"><a class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" href="javascript:addAlbum(<?php echo $view->tome->ID_TOME; ?>, <?php echo $view->tome->ID_EDITION; ?>,\'N\')" title="Ajouter cet album dans votre collection">Dans ma collection</a> - <a class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" href="javascript:addAlbum(<?php echo $view->tome->ID_TOME; ?>, <?php echo $view->tome->ID_EDITION; ?>,\'O\')" title="A acheter prochainement">Futur Achat</a></div>';
               $("#actionCollection").html(madiv);
               
           }
           else {
               $("#info_collection").show();
                var dte = data[0].DATE_AJOUT.substring(8,10) + "/" +   data[0].DATE_AJOUT.substring(5,7) + "/" +  data[0].DATE_AJOUT.substring(0,4);
                if (data[0].FLG_ACHAT === "O") {
                    $("#actionCollection" ).html('<div id="addAlbum' + <?php echo $view->tome->ID_EDITION; ?> + '" style="font-size:0.9em;">ajouté à vos futurs achats le ' +dte + '<br><a class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" href="#" onclick="addAlbum(' + <?php echo $view->tome->ID_TOME; ?> + ', ' + <?php echo $view->tome->ID_EDITION; ?> + ',\'N\');$(\'#cb_achat\').attr(\'checked\', false);" title="Ajouter cet album dans votre collection">Dans ma collection</a>  - <a class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" title="Supprimer l\' édition de ma collection" onclick="deleteEdition(' + <?php echo $view->tome->ID_EDITION; ?> + ')">Supprimer</a></div>');
                } else {
                    $("#actionCollection").html('<div id="addAlbum' + <?php echo $view->tome->ID_EDITION; ?> + '" style="font-size:0.9em;">ajouté à votre collection le ' + dte + ' - <a class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" title="Supprimer l\' édition de ma collection" onclick="deleteEdition(' + <?php echo $view->tome->ID_EDITION; ?> + ')">Supprimer</a></div>');
                }
              // $("#actionCollection").html('<div id="addAlbum<?php echo $view->tome->ID_EDITION; ?>" style="font-size:0.9em;">ajouté à votre collection le '+data[0].DATE_ACHAT.substring(0,10) +' - <a class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" title="Supprimer l\' édition de ma collection" onclick="deleteEdition(<?php echo $view->tome->ID_EDITION; ?>)">Supprimer</a></div>');
          
               // on renseigne chaque champs du formulaire
               if (data[0].FLG_ACHAT == 'O') {
                   $('#cb_achat').attr('checked', true);
               } else {
                   $("#date_achat").val(data[0].DATE_ACHAT.substring(8,10)+ '/' + data[0].DATE_ACHAT.substring(5,7)+ '/' + data[0].DATE_ACHAT.substring(0,4));
               }
                if (data[0].FLG_PRET == 'O') {
                   $('#cb_pret').attr('checked', true);
               }
               if (data[0].FLG_LU == 'O') {
                   $('#cb_lu').attr('checked', true);
               }
               $("#prix").val(data[0].cote);
               
                if (data[0].FLG_TETE == 'O') {
                   $('#cb_tete').attr('checked', true);
               } 
               if (data[0].FLG_DEDICACE == 'O') {
                   $('#cb_dedicace').attr('checked', true);
               } 
               if (data[0].FLG_CADEAU == 'O') {
                   $('#cb_cadeau').attr('checked', true);
               } 
               $("#nom_pret").val(data[0].NOM_PRET);
               $("#email_pret").val(data[0].EMAIL_PRET);
               $("#remarque").val(data[0].comment);
                $("#user_edition").val(data[0].ID_EDITION);
           }
        
        }

    );
    }
    getInfoCollection ();
   <?php } ?>
         
</script>
